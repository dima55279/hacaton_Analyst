<!DOCTYPE html>
<html>
<head>
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π –≥—Ä–∞–∂–¥–∞–Ω</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filters { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .loading { color: #666; text-align: center; padding: 20px; }
        .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .empty-state { color: #666; text-align: center; padding: 40px; }
    </style>
</head>
<body>
    <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π –≥—Ä–∞–∂–¥–∞–Ω</h1>
    
    <div class="filters">
        <label>–ü–µ—Ä–∏–æ–¥:</label>
        <select id="periodSelect">
            <option value="7">7 –¥–Ω–µ–π</option>
            <option value="30" selected>30 –¥–Ω–µ–π</option>
            <option value="90">90 –¥–Ω–µ–π</option>
        </select>
    </div>

    <div class="dashboard">
        <div class="card">
            <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º</h3>
            <div id="typeChartContainer">
                <div class="loading" id="typeChartLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <canvas id="typeChart" style="display: none;"></canvas>
                <div class="empty-state" id="typeChartEmpty" style="display: none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                <div class="error" id="typeChartError" style="display: none;"></div>
            </div>
        </div>
        
        <div class="card">
            <h3>–°—Ç–∞—Ç—É—Å—ã –æ–±—Ä–∞—â–µ–Ω–∏–π</h3>
            <div id="statusChartContainer">
                <div class="loading" id="statusChartLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <canvas id="statusChart" style="display: none;"></canvas>
                <div class="empty-state" id="statusChartEmpty" style="display: none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                <div class="error" id="statusChartError" style="display: none;"></div>
            </div>
        </div>
        
        <div class="card" style="grid-column: span 2;">
            <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è</h3>
            <div id="appealsTableContainer">
                <div class="loading" id="appealsTableLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <div id="appealsTable" style="display: none;"></div>
                <div class="empty-state" id="appealsTableEmpty" style="display: none;">–ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                <div class="error" id="appealsTableError" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        let typeChart, statusChart;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º UI
        function showLoading(elementId) {
            document.getElementById(elementId + 'Loading').style.display = 'block';
            document.getElementById(elementId).style.display = 'none';
            document.getElementById(elementId + 'Empty').style.display = 'none';
            document.getElementById(elementId + 'Error').style.display = 'none';
        }

        function showContent(elementId) {
            document.getElementById(elementId + 'Loading').style.display = 'none';
            document.getElementById(elementId).style.display = 'block';
            document.getElementById(elementId + 'Empty').style.display = 'none';
            document.getElementById(elementId + 'Error').style.display = 'none';
        }

        function showEmpty(elementId) {
            document.getElementById(elementId + 'Loading').style.display = 'none';
            document.getElementById(elementId).style.display = 'none';
            document.getElementById(elementId + 'Empty').style.display = 'block';
            document.getElementById(elementId + 'Error').style.display = 'none';
        }

        function showError(elementId, message) {
            document.getElementById(elementId + 'Loading').style.display = 'none';
            document.getElementById(elementId).style.display = 'none';
            document.getElementById(elementId + 'Empty').style.display = 'none';
            const errorElement = document.getElementById(elementId + 'Error');
            errorElement.style.display = 'block';
            errorElement.textContent = message;
        }

        async function loadData() {
            const period = document.getElementById('periodSelect').value;
            
            showLoading('typeChart');
            showLoading('statusChart');
            showLoading('appealsTable');
            
            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const statsResponse = await fetch(`/api/stats?period=${period}`);
                if (!statsResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${statsResponse.status}`);
                }
                const stats = await statsResponse.json();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–Ω–¥–æ–≤
                const trendsResponse = await fetch(`/api/trends?period=${period}`);
                if (!trendsResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤: ${trendsResponse.status}`);
                }
                const trends = await trendsResponse.json();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
                const appealsResponse = await fetch('/api/appeals?limit=10');
                if (!appealsResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π: ${appealsResponse.status}`);
                }
                const appeals = await appealsResponse.json();
                
                updateCharts(stats, trends);
                updateAppealsTable(appeals);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError('typeChart', error.message);
                showError('statusChart', error.message);
                showError('appealsTable', error.message);
            }
        }

        function processTypeData(stats) {
            // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Ç–∏–ø–∞–º –æ–±—Ä–∞—â–µ–Ω–∏–π
            const typeCounts = {};
            
            stats.forEach(stat => {
                const type = stat.type || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                typeCounts[type] = (typeCounts[type] || 0) + stat.count;
            });
            
            const labels = Object.keys(typeCounts);
            const data = Object.values(typeCounts);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã
            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            
            return {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    hoverBackgroundColor: backgroundColors.slice(0, labels.length)
                }]
            };
        }

        function processStatusData(stats) {
            // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
            const statusCounts = {};
            
            stats.forEach(stat => {
                const status = stat.status || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                statusCounts[status] = (statusCounts[status] || 0) + stat.count;
            });
            
            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
            const statusColors = {
                'new': '#36A2EB',
                'answered': '#4BC0C0', 
                'in_progress': '#FFCE56',
                'requires_manual_review': '#FF6384',
                'closed': '#9966FF'
            };
            
            const backgroundColors = labels.map(label => statusColors[label] || '#C9CBCF');
            
            return {
                labels: labels,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors,
                    borderWidth: 1
                }]
            };
        }

        function updateCharts(stats, trends) {
            if (!stats || stats.length === 0) {
                showEmpty('typeChart');
                showEmpty('statusChart');
                return;
            }
            
            try {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
                const typeData = processTypeData(stats);
                const statusData = processStatusData(stats);
                
                if (typeChart) typeChart.destroy();
                if (statusChart) statusChart.destroy();
                
                // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –¥–ª—è —Ç–∏–ø–æ–≤
                if (typeData.labels.length > 0) {
                    typeChart = new Chart(document.getElementById('typeChart'), {
                        type: 'pie',
                        data: typeData,
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'right',
                                },
                                title: {
                                    display: true,
                                    text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –æ–±—Ä–∞—â–µ–Ω–∏–π'
                                }
                            }
                        }
                    });
                    showContent('typeChart');
                } else {
                    showEmpty('typeChart');
                }
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç–æ–ª–±—á–∞—Ç—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
                if (statusData.labels.length > 0) {
                    statusChart = new Chart(document.getElementById('statusChart'), {
                        type: 'bar',
                        data: statusData,
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: '–°—Ç–∞—Ç—É—Å—ã –æ–±—Ä–∞—â–µ–Ω–∏–π'
                                }
                            }
                        }
                    });
                    showContent('statusChart');
                } else {
                    showEmpty('statusChart');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
                showError('typeChart', '–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤');
                showError('statusChart', '–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤');
            }
        }

        function updateAppealsTable(appeals) {
            if (!appeals || appeals.length === 0) {
                showEmpty('appealsTable');
                return;
            }
            
            try {
                const table = document.getElementById('appealsTable');
                let html = '<table><tr><th>ID</th><th>–¢–∏–ø</th><th>–¢–µ–∫—Å—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th></tr>';
                
                appeals.forEach(appeal => {
                    const appealType = appeal.type || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                    const appealText = appeal.text ? appeal.text.substring(0, 100) + '...' : '';
                    const appealStatus = appeal.status || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                    const appealDate = appeal.created_at ? new Date(appeal.created_at).toLocaleDateString() : '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                    
                    html += `<tr>
                        <td>${appeal.id}</td>
                        <td>${appealType}</td>
                        <td>${appealText}</td>
                        <td>${appealStatus}</td>
                        <td>${appealDate}</td>
                    </tr>`;
                });
                
                html += '</table>';
                table.innerHTML = html;
                showContent('appealsTable');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:', error);
                showError('appealsTable', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—â–µ–Ω–∏–π');
            }
        }

        document.getElementById('periodSelect').addEventListener('change', loadData);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadData, 30000);
    </script>
</body>
</html>