<!DOCTYPE html>
<html>
<head>
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π –≥—Ä–∞–∂–¥–∞–Ω</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filters { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .loading { color: #666; text-align: center; padding: 20px; }
        .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .empty-state { color: #666; text-align: center; padding: 40px; }
        .section-title { grid-column: span 2; margin-top: 30px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .heatmap-cell { padding: 8px; text-align: center; border: 1px solid #ddd; }
        .heatmap-header { font-weight: bold; background: #f5f5f5; }
    </style>
</head>
<body>
    <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π –≥—Ä–∞–∂–¥–∞–Ω</h1>
    
    <div class="filters">
        <label>–ü–µ—Ä–∏–æ–¥:</label>
        <select id="periodSelect">
            <option value="7">7 –¥–Ω–µ–π</option>
            <option value="30" selected>30 –¥–Ω–µ–π</option>
            <option value="90">90 –¥–Ω–µ–π</option>
        </select>
    </div>

    <div class="dashboard">
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="card">
            <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º</h3>
            <div id="typeChartContainer">
                <div class="loading" id="typeChartLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <canvas id="typeChart" style="display: none;"></canvas>
                <div class="empty-state" id="typeChartEmpty" style="display: none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                <div class="error" id="typeChartError" style="display: none;"></div>
            </div>
        </div>
        
        <div class="card">
            <h3>–°—Ç–∞—Ç—É—Å—ã –æ–±—Ä–∞—â–µ–Ω–∏–π</h3>
            <div id="statusChartContainer">
                <div class="loading" id="statusChartLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <canvas id="statusChart" style="display: none;"></canvas>
                <div class="empty-state" id="statusChartEmpty" style="display: none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                <div class="error" id="statusChartError" style="display: none;"></div>
            </div>
        </div>
        
        <!-- –†–∞–∑–¥–µ–ª –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ -->
        <div class="section-title">
            <h2>üèõÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º</h2>
        </div>
        
        <div class="card">
            <h3>–¢–æ–ø –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—è–º</h3>
            <div id="municipalityBarChartContainer">
                <div class="loading" id="municipalityBarChartLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <canvas id="municipalityBarChart" style="display: none;"></canvas>
                <div class="empty-state" id="municipalityBarChartEmpty" style="display: none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º</div>
                <div class="error" id="municipalityBarChartError" style="display: none;"></div>
            </div>
        </div>
        
        <div class="card">
            <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º</h3>
            <div id="municipalityPieChartContainer">
                <div class="loading" id="municipalityPieChartLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <canvas id="municipalityPieChart" style="display: none;"></canvas>
                <div class="empty-state" id="municipalityPieChartEmpty" style="display: none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º</div>
                <div class="error" id="municipalityPieChartError" style="display: none;"></div>
            </div>
        </div>
        
        <div class="card" style="grid-column: span 2;">
            <h3>–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞: —Ç–∏–ø—ã –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º</h3>
            <div id="municipalityHeatmapContainer">
                <div class="loading" id="municipalityHeatmapLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <div id="municipalityHeatmap" style="display: none; overflow-x: auto;"></div>
                <div class="empty-state" id="municipalityHeatmapEmpty" style="display: none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã</div>
                <div class="error" id="municipalityHeatmapError" style="display: none;"></div>
            </div>
        </div>
        
        <!-- –¢–∞–±–ª–∏—Ü–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π -->
        <div class="card" style="grid-column: span 2;">
            <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è</h3>
            <div id="appealsTableContainer">
                <div class="loading" id="appealsTableLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                <div id="appealsTable" style="display: none;"></div>
                <div class="empty-state" id="appealsTableEmpty" style="display: none;">–ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                <div class="error" id="appealsTableError" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        let typeChart, statusChart, municipalityBarChart, municipalityPieChart;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º UI
        function showLoading(elementId) {
            document.getElementById(elementId + 'Loading').style.display = 'block';
            document.getElementById(elementId).style.display = 'none';
            document.getElementById(elementId + 'Empty').style.display = 'none';
            document.getElementById(elementId + 'Error').style.display = 'none';
        }

        function showContent(elementId) {
            document.getElementById(elementId + 'Loading').style.display = 'none';
            document.getElementById(elementId).style.display = 'block';
            document.getElementById(elementId + 'Empty').style.display = 'none';
            document.getElementById(elementId + 'Error').style.display = 'none';
        }

        function showEmpty(elementId) {
            document.getElementById(elementId + 'Loading').style.display = 'none';
            document.getElementById(elementId).style.display = 'none';
            document.getElementById(elementId + 'Empty').style.display = 'block';
            document.getElementById(elementId + 'Error').style.display = 'none';
        }

        function showError(elementId, message) {
            document.getElementById(elementId + 'Loading').style.display = 'none';
            document.getElementById(elementId).style.display = 'none';
            document.getElementById(elementId + 'Empty').style.display = 'none';
            const errorElement = document.getElementById(elementId + 'Error');
            errorElement.style.display = 'block';
            errorElement.textContent = message;
        }

        async function loadData() {
            const period = document.getElementById('periodSelect').value;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–ª—è –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
            showLoading('typeChart');
            showLoading('statusChart');
            showLoading('municipalityBarChart');
            showLoading('municipalityPieChart');
            showLoading('municipalityHeatmap');
            showLoading('appealsTable');
            
            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const statsResponse = await fetch(`/api/stats?period=${period}`);
                if (!statsResponse.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${statsResponse.status}`);
                const stats = await statsResponse.json();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–Ω–¥–æ–≤
                const trendsResponse = await fetch(`/api/trends?period=${period}`);
                if (!trendsResponse.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤: ${trendsResponse.status}`);
                const trends = await trendsResponse.json();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º
                const municipalityStatsResponse = await fetch(`/api/municipality_stats?period=${period}`);
                if (!municipalityStatsResponse.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º: ${municipalityStatsResponse.status}`);
                const municipalityStats = await municipalityStatsResponse.json();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ç–∏–ø–∞–º –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞—Ö
                const municipalityTypeStatsResponse = await fetch(`/api/municipality_type_stats?period=${period}`);
                if (!municipalityTypeStatsResponse.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ç–∏–ø–∞–º –æ–±—Ä–∞—â–µ–Ω–∏–π: ${municipalityTypeStatsResponse.status}`);
                const municipalityTypeStats = await municipalityTypeStatsResponse.json();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
                const appealsResponse = await fetch('/api/appeals?limit=10');
                if (!appealsResponse.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π: ${appealsResponse.status}`);
                const appeals = await appealsResponse.json();
                
                updateCharts(stats, trends);
                updateMunicipalityCharts(municipalityStats, municipalityTypeStats);
                updateAppealsTable(appeals);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError('typeChart', error.message);
                showError('statusChart', error.message);
                showError('municipalityBarChart', error.message);
                showError('municipalityPieChart', error.message);
                showError('municipalityHeatmap', error.message);
                showError('appealsTable', error.message);
            }
        }

        function processTypeData(stats) {
            // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Ç–∏–ø–∞–º –æ–±—Ä–∞—â–µ–Ω–∏–π
            const typeCounts = {};
            
            stats.forEach(stat => {
                const type = stat.type || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                typeCounts[type] = (typeCounts[type] || 0) + stat.count;
            });
            
            const labels = Object.keys(typeCounts);
            const data = Object.values(typeCounts);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã
            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            
            return {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    hoverBackgroundColor: backgroundColors.slice(0, labels.length)
                }]
            };
        }

        function processStatusData(stats) {
            // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
            const statusCounts = {};
            
            stats.forEach(stat => {
                const status = stat.status || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                statusCounts[status] = (statusCounts[status] || 0) + stat.count;
            });
            
            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
            const statusColors = {
                'new': '#36A2EB',
                'answered': '#4BC0C0', 
                'in_progress': '#FFCE56',
                'requires_manual_review': '#FF6384',
                'closed': '#9966FF'
            };
            
            const backgroundColors = labels.map(label => statusColors[label] || '#C9CBCF');
            
            return {
                labels: labels,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors,
                    borderWidth: 1
                }]
            };
        }

        function updateCharts(stats, trends) {
            if (!stats || stats.length === 0) {
                showEmpty('typeChart');
                showEmpty('statusChart');
                return;
            }
            
            try {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
                const typeData = processTypeData(stats);
                const statusData = processStatusData(stats);
                
                if (typeChart) typeChart.destroy();
                if (statusChart) statusChart.destroy();
                
                // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –¥–ª—è —Ç–∏–ø–æ–≤
                if (typeData.labels.length > 0) {
                    typeChart = new Chart(document.getElementById('typeChart'), {
                        type: 'pie',
                        data: typeData,
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'right',
                                },
                                title: {
                                    display: true,
                                    text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –æ–±—Ä–∞—â–µ–Ω–∏–π'
                                }
                            }
                        }
                    });
                    showContent('typeChart');
                } else {
                    showEmpty('typeChart');
                }
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç–æ–ª–±—á–∞—Ç—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
                if (statusData.labels.length > 0) {
                    statusChart = new Chart(document.getElementById('statusChart'), {
                        type: 'bar',
                        data: statusData,
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: '–°—Ç–∞—Ç—É—Å—ã –æ–±—Ä–∞—â–µ–Ω–∏–π'
                                }
                            }
                        }
                    });
                    showContent('statusChart');
                } else {
                    showEmpty('statusChart');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
                showError('typeChart', '–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤');
                showError('statusChart', '–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤');
            }
        }

        // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ú–£–ù–ò–¶–ò–ü–ê–õ–ò–¢–ï–¢–û–í
        function updateMunicipalityCharts(municipalityStats, municipalityTypeStats) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤
            updateMunicipalityBarChart(municipalityStats);
            updateMunicipalityPieChart(municipalityStats);
            updateMunicipalityHeatmap(municipalityTypeStats);
        }

        function updateMunicipalityBarChart(stats) {
            if (!stats || stats.length === 0) {
                showEmpty('municipalityBarChart');
                return;
            }
            
            try {
                // –§–∏–ª—å—Ç—Ä—É–µ–º –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã (—É–±–∏—Ä–∞–µ–º "–ù–µ —É–∫–∞–∑–∞–Ω")
                const validStats = stats.filter(s => s.municipality !== '–ù–µ —É–∫–∞–∑–∞–Ω');
                
                if (validStats.length === 0) {
                    showEmpty('municipalityBarChart');
                    return;
                }
                
                // –ë–µ—Ä–µ–º —Ç–æ–ø-10
                const topStats = validStats.slice(0, 10);
                
                const labels = topStats.map(s => s.municipality);
                const data = topStats.map(s => s.appeal_count);
                
                // –¶–≤–µ—Ç–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
                const backgroundColors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                    '#4BC0C0', '#9966FF'
                ];
                
                if (municipalityBarChart) municipalityBarChart.destroy();
                
                municipalityBarChart = new Chart(document.getElementById('municipalityBarChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π',
                            data: data,
                            backgroundColor: backgroundColors.slice(0, labels.length),
                            borderColor: backgroundColors.slice(0, labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: '–¢–æ–ø –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—è–º'
                            }
                        }
                    }
                });
                
                showContent('municipalityBarChart');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–±—á–∞—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤:', error);
                showError('municipalityBarChart', '–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞');
            }
        }

        function updateMunicipalityPieChart(stats) {
            if (!stats || stats.length === 0) {
                showEmpty('municipalityPieChart');
                return;
            }
            
            try {
                // –§–∏–ª—å—Ç—Ä—É–µ–º –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç—ã (—É–±–∏—Ä–∞–µ–º "–ù–µ —É–∫–∞–∑–∞–Ω")
                const validStats = stats.filter(s => s.municipality !== '–ù–µ —É–∫–∞–∑–∞–Ω');
                
                if (validStats.length === 0) {
                    showEmpty('municipalityPieChart');
                    return;
                }
                
                // –ë–µ—Ä–µ–º —Ç–æ–ø-8, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–¥–∏–Ω—è–µ–º –≤ "–î—Ä—É–≥–∏–µ"
                let topStats, otherCount;
                if (validStats.length > 8) {
                    topStats = validStats.slice(0, 8);
                    otherCount = validStats.slice(8).reduce((sum, s) => sum + s.appeal_count, 0);
                    topStats.push({
                        municipality: '–î—Ä—É–≥–∏–µ',
                        appeal_count: otherCount
                    });
                } else {
                    topStats = validStats;
                }
                
                const labels = topStats.map(s => s.municipality);
                const data = topStats.map(s => s.appeal_count);
                
                // –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞
                const backgroundColors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                    '#4BC0C0'
                ];
                
                if (municipalityPieChart) municipalityPieChart.destroy();
                
                municipalityPieChart = new Chart(document.getElementById('municipalityPieChart'), {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors.slice(0, labels.length),
                            hoverBackgroundColor: backgroundColors.slice(0, labels.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: true,
                                text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º'
                            }
                        }
                    }
                });
                
                showContent('municipalityPieChart');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–æ–≤:', error);
                showError('municipalityPieChart', '–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞');
            }
        }

        function updateMunicipalityHeatmap(typeStats) {
            if (!typeStats || typeStats.length === 0) {
                showEmpty('municipalityHeatmap');
                return;
            }
            
            try {
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
                const municipalities = [...new Set(typeStats.map(s => s.municipality))].filter(m => m !== '–ù–µ —É–∫–∞–∑–∞–Ω');
                const appealTypes = [...new Set(typeStats.map(s => s.appeal_type))].filter(t => t !== '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
                
                if (municipalities.length === 0 || appealTypes.length === 0) {
                    showEmpty('municipalityHeatmap');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É –¥–∞–Ω–Ω—ã—Ö
                const dataMatrix = {};
                municipalities.forEach(mun => {
                    dataMatrix[mun] = {};
                    appealTypes.forEach(type => {
                        dataMatrix[mun][type] = 0;
                    });
                });
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Ç—Ä–∏—Ü—É
                typeStats.forEach(stat => {
                    if (stat.municipality !== '–ù–µ —É–∫–∞–∑–∞–Ω' && stat.appeal_type !== '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω') {
                        dataMatrix[stat.municipality][stat.appeal_type] = stat.type_count;
                    }
                });
                
                // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Ç–∏–ø–∞–º–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π
                html += '<tr><th class="heatmap-header">–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç / –¢–∏–ø –æ–±—Ä–∞—â–µ–Ω–∏—è</th>';
                appealTypes.forEach(type => {
                    html += `<th class="heatmap-header">${type}</th>`;
                });
                html += '</tr>';
                
                // –î–∞–Ω–Ω—ã–µ –ø–æ –º—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç–∞–º
                municipalities.forEach(municipality => {
                    html += `<tr><td class="heatmap-header">${municipality}</td>`;
                    appealTypes.forEach(type => {
                        const count = dataMatrix[municipality][type];
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —è—á–µ–π–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                        let color = '#ffffff';
                        if (count > 0) {
                            const intensity = Math.min(count / 10, 1); // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ 10+ –æ–±—Ä–∞—â–µ–Ω–∏—è—Ö
                            color = `rgba(255, 99, 132, ${0.3 + intensity * 0.7})`;
                        }
                        html += `<td class="heatmap-cell" style="background-color: ${color}">${count}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table>';
                
                document.getElementById('municipalityHeatmap').innerHTML = html;
                showContent('municipalityHeatmap');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã:', error);
                showError('municipalityHeatmap', '–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã');
            }
        }

        function updateAppealsTable(appeals) {
            if (!appeals || appeals.length === 0) {
                showEmpty('appealsTable');
                return;
            }
            
            try {
                const table = document.getElementById('appealsTable');
                let html = '<table><tr><th>ID</th><th>–¢–∏–ø</th><th>–¢–µ–∫—Å—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ú—É–Ω–∏—Ü–∏–ø–∞–ª–∏—Ç–µ—Ç</th><th>–î–∞—Ç–∞</th></tr>';
                
                appeals.forEach(appeal => {
                    const appealType = appeal.type || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                    const appealText = appeal.text ? appeal.text.substring(0, 100) + '...' : '';
                    const appealStatus = appeal.status || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                    const appealMunicipality = appeal.district || '–Ω–µ —É–∫–∞–∑–∞–Ω';
                    const appealDate = appeal.created_at ? new Date(appeal.created_at).toLocaleDateString() : '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                    
                    html += `<tr>
                        <td>${appeal.id}</td>
                        <td>${appealType}</td>
                        <td>${appealText}</td>
                        <td>${appealStatus}</td>
                        <td>${appealMunicipality}</td>
                        <td>${appealDate}</td>
                    </tr>`;
                });
                
                html += '</table>';
                table.innerHTML = html;
                showContent('appealsTable');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:', error);
                showError('appealsTable', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—â–µ–Ω–∏–π');
            }
        }

        document.getElementById('periodSelect').addEventListener('change', loadData);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadData, 30000);
    </script>
</body>
</html>